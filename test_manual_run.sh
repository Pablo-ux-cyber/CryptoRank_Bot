#!/bin/bash

# –†—É—á–Ω–æ–π —Ç–µ—Å—Ç —Å–∫—Ä–∏–ø—Ç–∞ —Å –ø–æ–¥—Ä–æ–±–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π

echo "üß™ –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ run_test_message.sh"
echo "=================================================="
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–∞
if [ ! -f "run_test_message.sh" ]; then
    echo "‚ùå –§–∞–π–ª run_test_message.sh –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi

if [ ! -x "run_test_message.sh" ]; then
    echo "‚ö†Ô∏è  –§–∞–π–ª –Ω–µ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π, –¥–µ–ª–∞–µ–º –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º..."
    chmod +x run_test_message.sh
fi

# –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
echo "‚è∞ –í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞: $(date)"
echo "üìç –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å IP
SERVER_IP=$(hostname -I | awk '{print $1}')
echo "üåê –û–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π IP: $SERVER_IP"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞
echo "üîó –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞..."
if curl -s --connect-timeout 5 "http://$SERVER_IP:5000/health" > /dev/null 2>&1; then
    echo "‚úÖ –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω"
else
    echo "‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ Flask –∑–∞–ø—É—â–µ–Ω"
    echo ""
    echo "üí° –î–ª—è –∑–∞–ø—É—Å–∫–∞ Flask:"
    echo "   python main.py"
    echo "   –∏–ª–∏"
    echo "   gunicorn --bind 0.0.0.0:5000 main:app"
    exit 1
fi

echo ""
echo "üöÄ –ó–∞–ø—É—Å–∫ run_test_message.sh..."
echo "–õ–æ–≥–∏ –±—É–¥—É—Ç –ø–æ–∫–∞–∑–∞–Ω—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏:"
echo "----------------------------------------"

# –ó–∞–ø—É—Å–∫ —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –ª–æ–≥–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
./run_test_message.sh

echo ""
echo "----------------------------------------"
echo "‚úÖ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!"
echo ""

# –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –∏–∑ –ª–æ–≥–∞
if [ -f "/tmp/test_message_cron.log" ]; then
    echo "üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –∏–∑ –ª–æ–≥–∞ cron:"
    tail -10 /tmp/test_message_cron.log
else
    echo "‚ÑπÔ∏è  –õ–æ–≥ —Ñ–∞–π–ª /tmp/test_message_cron.log –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

echo ""
echo "üèÅ –†—É—á–Ω–æ–π —Ç–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω: $(date)"