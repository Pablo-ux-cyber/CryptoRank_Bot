#!/usr/bin/env python3
"""
КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ ПЛАНИРОВЩИКА

Проблема: Планировщик проверяет время каждые 60 минут, но пропускает точное время 08:01:00
Решение: Изменить логику сна для точной проверки времени

Проблемный код в scheduler.py:
- Спит ровно 60 минут между проверками
- Пропускает окно времени 08:01:00

Нужно изменить:
- Спать меньше времени (например, каждые 30 секунд) в критический период
- Или спать точно до 08:01:00 вместо фиксированных 60 минут
"""

# Исправленная логика для scheduler.py строки 125-140:

OLD_CODE = """
                # Решаем сколько спать до следующей проверки
                sleep_time = min(time_diff, 3600)  # Максимум 1 час
                if sleep_time > 0:
                    logger.info(f"Планировщик спит {int(sleep_time/60)} минут до следующей проверки")
                    self.stop_event.wait(sleep_time)
"""

NEW_CODE = """
                # ИСПРАВЛЕНО: В критический период проверяем каждые 30 секунд
                if time_diff <= 300:  # Если до запуска меньше 5 минут
                    sleep_time = 30  # Проверяем каждые 30 секунд
                    logger.info(f"Планировщик в режиме точной проверки, спит 30 секунд")
                else:
                    # Обычный режим - спим до нужного времени, но не больше 1 часа
                    sleep_time = min(time_diff - 300, 3600)  # Оставляем 5 минут запаса
                    logger.info(f"Планировщик спит {int(sleep_time/60)} минут до следующей проверки")
                
                if sleep_time > 0:
                    self.stop_event.wait(sleep_time)
"""

print("Нужно применить исправление к scheduler.py на сервере")